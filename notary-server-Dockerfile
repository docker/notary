FROM golang

RUN apt-get update && apt-get install -y \
    libltdl-dev \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*

# Install Reefer.
ADD https://github.com/docker-infra/reefer/releases/download/v0.0.3/reefer.gz /usr/bin/reefer.gz
RUN gunzip /usr/bin/reefer.gz && chmod a+x /usr/bin/reefer

EXPOSE 4443

ENV NOTARYPKG github.com/docker/notary
ENV GOPATH /go/src/${NOTARYPKG}/Godeps/_workspace:$GOPATH
ENV LOG_LEVEL debug
ENV DB_USER dockercondemo
ENV DB_PASSWORD dockercondemo
ENV DB_HOST notarymysql
ENV DB_NAME dockercondemo

COPY . /go/src/github.com/docker/notary
COPY cmd/notary-server/config.json.tmpl /etc/docker/notary/config.json.tmpl

WORKDIR /go/src/${NOTARYPKG}

RUN go install \
    -ldflags "-w -X ${NOTARYPKG}/version.GitCommit `git rev-parse --short HEAD` -X ${NOTARYPKG}/version.NotaryVersion `cat NOTARY_VERSION`" \
    ${NOTARYPKG}/cmd/notary-server

ENTRYPOINT [ "/usr/bin/reefer", "-e", "GOMAXPROCS", "-t", "/etc/docker/notary/config.json.tmpl", "/go/bin/notary-server", "-config", "/etc/docker/notary/config.json"]
CMD []
